<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rubina's Speed Tracker</title>
  <style>
    /* Futuristic minimal UI */
    :root{
      --bg:#06070a;
      --card:#0f1724;
      --accent:#00ffd5;
      --accent2:#8a5fff;
      --glass: rgba(255,255,255,0.04);
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#01040a 0%, #071025 60%);color:#e6f7ff}
    .app{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:720px;padding:28px;border-radius:18px;backdrop-filter: blur(6px);background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 10px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)}
    h1{font-size:28px;text-align:center;margin:6px 0 22px;letter-spacing:3px;color:var(--accent)}
    .subtitle{color:#b9dff0;text-align:center;margin-bottom:18px}
    .center{display:flex;gap:18px;align-items:center;justify-content:center}
    .btn{--size:120px;width:140px;height:56px;border-radius:14px;border:none;cursor:pointer;font-weight:700;letter-spacing:1px;transition:transform .16s ease, box-shadow .16s ease;display:inline-flex;align-items:center;justify-content:center;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#02101a;box-shadow:0 8px 30px rgba(0,0,0,0.6), 0 2px 8px rgba(138,95,255,0.12)}
    .btn:active{transform:translateY(2px)}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#dbefff}
    .status{margin-top:20px;padding:14px;border-radius:12px;background:var(--glass);display:flex;gap:12px;align-items:center}
    .dot{width:12px;height:12px;border-radius:99px;background:#ff6b6b;box-shadow:0 0 10px rgba(255,107,107,0.18)}
    .dot.ok{background:#32d583;box-shadow:0 0 14px rgba(50,213,131,0.14)}
    .meta{font-size:14px;color:#cfeeff}
    .big{font-size:42px;font-weight:800;color:#fff;text-align:center;margin-top:18px}
    .small{font-size:13px;color:#9fc9e6;text-align:center}
    footer{margin-top:18px;font-size:12px;color:#84b7d9;text-align:center}
    @media (max-width:520px){.btn{width:120px;height:48px}}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>Rubina's Speed Tracker</h1>
      <div class="subtitle">Simple — Animated — Android-first background-friendly</div>

      <div class="center">
        <button id="startBtn" class="btn">Start Tracking</button>
        <button id="stopBtn" class="btn secondary">Stop</button>
      </div>

      <div class="status" style="margin-top:18px">
        <div id="connDot" class="dot"></div>
        <div class="meta">
          <div id="statusText">Idle — not tracking</div>
          <div id="coords" style="font-size:13px;margin-top:6px;color:#9fc9e6">--</div>
        </div>
      </div>

      <div class="big" id="currentLimit">-- mph</div>
      <div class="small" id="currentRoad">Waiting for GPS...</div>

      <footer>
        Plays 20/30/40/50/60/70 .mp3 from root. Uses HERE API for speed-limit lookup.
      </footer>
    </div>
  </div>

  <!-- Audio elements for the six speed files (user will place these in the same root) -->
  <audio id="a20" preload="auto" src="20.mp3"></audio>
  <audio id="a30" preload="auto" src="30.mp3"></audio>
  <audio id="a40" preload="auto" src="40.mp3"></audio>
  <audio id="a50" preload="auto" src="50.mp3"></audio>
  <audio id="a60" preload="auto" src="60.mp3"></audio>
  <audio id="a70" preload="auto" src="70.mp3"></audio>

 <script>
// USER CONFIG
const API_KEY = '4zCvKqaOKYJonTwhkpPVeCm8x10Q1kOrb7fV97zHAAM'; 
const ANNOUNCE_INTERVAL_MS = 15000; // 15 seconds
const MIN_ACCURACY_METERS = 100; // Increased for mobile tolerance

// UI refs
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const statusText = document.getElementById('statusText');
const coordsEl = document.getElementById('coords');
const connDot = document.getElementById('connDot');
const currentLimitEl = document.getElementById('currentLimit');
const currentRoadEl = document.getElementById('currentRoad');

// Audio map
const audioMap = {
  20: document.getElementById('a20'),
  30: document.getElementById('a30'),
  40: document.getElementById('a40'),
  50: document.getElementById('a50'),
  60: document.getElementById('a60'),
  70: document.getElementById('a70')
};

let watchId = null;
let lastZone = null;
let announceTimer = null;
let wakeLock = null;
let lastGoodPosition = null;
let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

function setStatus(ok, text){
  statusText.textContent = text;
  connDot.className = 'dot ' + (ok? 'ok':'');
}

async function requestWakeLock(){
  if (!isMobile) return; // Only use wake lock on mobile
  
  try{
    if('wakeLock' in navigator){
      wakeLock = await navigator.wakeLock.request('screen');
      console.log('Wake lock acquired for mobile');
    }
  }catch(err){
    console.warn('Wake lock request failed',err);
  }
}

function releaseWakeLock(){
  try{
    if(wakeLock){ wakeLock.release(); wakeLock = null; }
  }catch(e){}
}

// MediaSession for mobile background behavior
function setMediaSessionMeta(limit){
  if('mediaSession' in navigator){
    navigator.mediaSession.metadata = new MediaMetadata({
      title: `Speed limit ${limit} mph`,
      artist: 'Rubina\'s Speed Tracker'
    });
  }
}

function playSpeedAudio(limit){
  const rounded = Math.round(limit/10)*10;
  const candidate = [20,30,40,50,60,70].reduce((acc,v)=> Math.abs(v-rounded) < Math.abs(acc-rounded) ? v : acc,20);
  
  const audio = audioMap[candidate];
  if(!audio) return;
  
  // Stop other audios
  Object.values(audioMap).forEach(a=>{ 
    try{ 
      a.pause(); 
      a.currentTime = 0;
    } catch(e){} 
  });
  
  // Mobile-specific audio handling
  audio.play().catch(err=>{
    console.warn('Mobile playback failed:', err);
    // On mobile, user might need to interact first
    if (isMobile) {
      setStatus(false, 'Tap screen to enable audio');
    }
  });
  setMediaSessionMeta(candidate);
}

function scheduleRepeater(limit){
  clearInterval(announceTimer);
  playSpeedAudio(limit);
  announceTimer = setInterval(()=> playSpeedAudio(limit), ANNOUNCE_INTERVAL_MS);
}

function stopRepeater(){
  clearInterval(announceTimer);
  announceTimer = null;
}

// Mobile-optimized geolocation with fallbacks
function startMobileGeolocation() {
  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
  }

  // Mobile-optimized settings
  const options = {
    enableHighAccuracy: true,
    maximumAge: isMobile ? 5000 : 0, // Longer cache for mobile
    timeout: isMobile ? 45000 : 30000 // Longer timeout for mobile GPS
  };

  console.log('Starting mobile geolocation with options:', options);
  
  watchId = navigator.geolocation.watchPosition(
    positionHandler, 
    mobileErrorHandler, 
    options
  );
}

// Enhanced error handler for mobile
function mobileErrorHandler(err){
  console.warn('Mobile geolocation error', err);
  let errorMsg = 'Mobile GPS: ';
  
  switch(err.code) {
    case err.PERMISSION_DENIED:
      errorMsg += 'Permission denied. Enable location in browser settings.';
      // Mobile-specific guidance
      if (isMobile) {
        errorMsg += ' (Check phone Settings > Site permissions)';
      }
      break;
    case err.POSITION_UNAVAILABLE:
      errorMsg += 'Signal weak. Move to open area.';
      if (isMobile) {
        errorMsg += ' Ensure Location is set to "High Accuracy".';
      }
      break;
    case err.TIMEOUT:
      errorMsg += 'GPS timeout. Phone may need 1-2 minutes to get satellite lock.';
      break;
    default:
      errorMsg += err.message || 'Check location settings';
  }
  
  setStatus(false, errorMsg);
  
  // Mobile-specific recovery suggestion
  if (isMobile) {
    setTimeout(() => {
      if (watchId) {
        setStatus(false, 'Still trying... Move phone to window or outdoors');
      }
    }, 5000);
  }
}

// Smart speed limit detection with better residential detection
function detectSpeedLimitFromAddress(roadName, address, lat, lng) {
  const roadLower = (roadName || '').toLowerCase();
  const addressLower = (address || '').toLowerCase();
  
  // RESIDENTIAL AREAS FIRST
  if (roadLower.includes('close') ||
      roadLower.includes('crescent') ||
      roadLower.includes('court') ||
      roadLower.includes('place') ||
      roadLower.includes('gardens') ||
      roadLower.includes('avenue') && !roadLower.includes('main') ||
      roadLower.includes('drive') && !roadLower.includes('main') ||
      addressLower.includes('residential') ||
      addressLower.includes('housing') ||
      addressLower.includes('estate') ||
      addressLower.includes('close') ||
      addressLower.includes('crescent') ||
      addressLower.includes('court')) {
    return 20;
  }
  
  // URBAN STREETS
  if (roadLower.includes('street') ||
      roadLower.includes('road') ||
      roadLower.includes('avenue') ||
      roadLower.includes('drive') ||
      roadLower.includes('lane') ||
      roadLower.includes('way') ||
      addressLower.includes('town') ||
      addressLower.includes('city') ||
      addressLower.includes('centre') ||
      addressLower.includes('urban') ||
      addressLower.includes('borough')) {
    return 30;
  }
  
  // Default safe speed for mobile
  return 30;
}

// Enhanced HERE API for mobile
async function getSpeedLimitHERE(lat, lng) {
  try {
    const geocodeUrl = `https://revgeocode.search.hereapi.com/v1/revgeocode?at=${lat},${lng}&apiKey=${API_KEY}`;
    const geocodeRes = await fetch(geocodeUrl);
    
    let speedLimit = null;
    let roadName = null;
    let address = null;
    
    if (geocodeRes.ok) {
      const geocodeData = await geocodeRes.json();
      
      if (geocodeData.items && geocodeData.items[0]) {
        const location = geocodeData.items[0];
        
        if (location.address) {
          const addr = location.address;
          roadName = addr.street || addr.road || null;
          
          if (addr.street && addr.city) {
            address = `${addr.street}, ${addr.city}`;
          } else if (addr.street && addr.county) {
            address = `${addr.street}, ${addr.county}`;
          } else if (addr.label) {
            address = addr.label.length > 50 ? addr.label.substring(0, 50) + '...' : addr.label;
          } else {
            address = addr.street || addr.district || addr.city || 'Getting location...';
          }
        }
        
        speedLimit = detectSpeedLimitFromAddress(roadName, address, lat, lng);
      }
    }
    
    return { 
      speed: speedLimit, 
      road: roadName,
      address: address 
    };
    
  } catch(e) {
    console.warn('HERE lookup failed', e);
    return { speed: null, road: null, address: null };
  }
}

async function lookupSpeedLimit(lat,lng){
  const result = await getSpeedLimitHERE(lat,lng);
  return result;
}

// Mobile-optimized position handler
async function positionHandler(pos){
  const accuracy = pos.coords.accuracy;
  const lat = pos.coords.latitude;
  const lng = pos.coords.longitude;

  // Mobile-specific accuracy handling
  let accuracyStatus = '';
  if (accuracy > 500) {
    accuracyStatus = 'POOR ACCURACY';
    setStatus(false, `Weak GPS: ${Math.round(accuracy)}m - Move outdoors`);
  } else if (accuracy > 100) {
    accuracyStatus = 'AVERAGE ACCURACY';
    setStatus(true, `GPS OK: ${Math.round(accuracy)}m`);
  } else {
    accuracyStatus = 'GOOD ACCURACY';
    setStatus(true, `Good GPS: ${Math.round(accuracy)}m`);
  }

  coordsEl.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)} — ${accuracyStatus} ${Math.round(accuracy)}m`;

  // Process position even with poor accuracy on mobile
  const lookup = await lookupSpeedLimit(lat, lng);
  
  let displayText = 'Getting location...';
  if (lookup.address) {
    displayText = lookup.address;
  } else if (lookup.road) {
    displayText = lookup.road;
  }
  
  currentRoadEl.textContent = displayText;
  
  let mph = lookup.speed || lastZone || 30;
  currentLimitEl.textContent = mph + ' mph';

  if (mph !== lastZone) {
    lastZone = mph;
    scheduleRepeater(mph);
    const locationDesc = lookup.road || lookup.address || 'current location';
    setStatus(true, `Tracking: ${mph} mph near ${locationDesc}`);
  }
}

// Mobile-specific start function
startBtn.addEventListener('click', async ()=>{
  if(!('geolocation' in navigator)){
    setStatus(false, 'Geolocation not supported');
    return;
  }
  
  // Mobile permission guidance
  if (isMobile) {
    setStatus(true, 'Allow location access when prompted...');
  }
  
  await requestWakeLock();
  startMobileGeolocation();
  
  startBtn.disabled = true;
  stopBtn.disabled = false;
});

stopBtn.addEventListener('click', ()=>{
  if(watchId !== null){ 
    navigator.geolocation.clearWatch(watchId); 
    watchId = null; 
  }
  stopRepeater();
  releaseWakeLock();
  lastZone = null;
  lastGoodPosition = null;
  startBtn.disabled = false;
  stopBtn.disabled = true;
  setStatus(false, 'Stopped');
  currentLimitEl.textContent = '-- mph';
  currentRoadEl.textContent = 'Not tracking';
  coordsEl.textContent = '--';
});

// Mobile initialization
if (isMobile) {
  console.log('Mobile browser detected - optimizing for phone');
  // Add mobile-specific UI hints
  document.addEventListener('click', function() {
    // This helps with audio autoplay on mobile
    Object.values(audioMap).forEach(audio => {
      audio.play().then(() => audio.pause()).catch(() => {});
    });
  }, { once: true });
}

// Init state
stopBtn.disabled = true;
setStatus(false, 'Idle — tap Start Tracking');

console.log('Mobile-optimized app loaded');
</script>
</body>
</html>
